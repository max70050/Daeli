<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kontoaktion - Dæli-Gruenwald</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        html {
            height: 100%;
        }
        
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: var(--bg); 
            padding: 20px;
        }

        .action-container {
            background: var(--card);
            padding: 25px 40px;
            border-radius: var(--border-radius-md);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            width: 100%;
            max-width: 420px;
            text-align: center;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .action-section {
            display: none;
        }
        
        .action-section.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

        .styled-message-box i {
            font-size: 3rem;
            color: var(--success);
            margin-bottom: 15px;
        }
        
        .styled-message-box.error i {
            color: var(--error);
        }

        .styled-message-box h2 {
            margin-bottom: 10px;
        }
        
        .styled-message-box p {
            color: var(--muted);
            line-height: 1.6;
            font-size: 0.95em;
            margin-bottom: 25px;
        }
        
        .loader {
            width: 40px;
            height: 40px;
            border: 4px solid var(--line);
            border-radius: 50%;
            border-top-color: var(--brand);
            animation: spin 1s ease-in-out infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .action-container h2 {
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.5rem;
        }
        
        .action-container input {
            font: inherit;
            width: 100%;
            padding: 12px;
            border: 1px solid var(--line);
            border-radius: var(--border-radius-sm);
            background: #fafafa;
            margin-bottom: 15px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        
        .action-container input:focus {
            outline: none;
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(106, 106, 67, 0.2);
        }
        
        .password-wrapper { 
            position: relative; 
            display: flex; 
            align-items: center; 
        }
        .password-wrapper input { padding-right: 40px; }
        .password-wrapper i { 
            position: absolute; 
            right: 15px; 
            cursor: pointer; 
            color: #999; 
            z-index: 2; 
        }

        #password-strength-feedback { 
            text-align: left; 
            font-size: 13px; 
            margin-top: -10px; 
            margin-bottom: 15px; 
        }
        #password-strength-feedback p { margin-bottom: 5px; font-weight: 600; }
        #password-strength-feedback ul { list-style: none; padding-left: 0; }
        #password-strength-feedback li { color: var(--muted); transition: color 0.3s ease; }
        #password-strength-feedback li.valid { color: var(--success); }
        #password-strength-feedback li.valid::before { content: '✓ '; }
        
        #reset-error-message {
            display: none;
            color: var(--error);
            font-size: 13px;
            margin-bottom: 15px;
        }

    </style>
</head>
<body>

    <div class="action-container">

        <div id="loading-view" class="action-section active">
            <h2>Bitte warten...</h2>
            <div class="loader"></div>
            <p id="loading-text" style="color: var(--muted); font-size: 0.9em;">Aktion wird verarbeitet.</p>
        </div>

        <div id="reset-view" class="action-section">
            <h2>Neues Passwort festlegen</h2>
            <p style="color: var(--muted); font-size: 0.9em; margin-top: -15px; margin-bottom: 20px;">Bitte gib ein neues, sicheres Passwort ein.</p>
            
            <div class="password-wrapper">
                <input type="password" id="reset-password" placeholder="Neues Passwort">
                <i class="fa-solid fa-eye-slash" id="toggle-reset-password"></i>
            </div>
            
            <div id="password-strength-feedback">
                <p>Das Passwort muss enthalten:</p>
                <ul>
                    <li id="length-check">Mindestens 8 Zeichen</li>
                    <li id="uppercase-check">Mindestens einen Großbuchstaben</li>
                    <li id="number-check">Mindestens eine Zahl</li>
                </ul>
            </div>
            
            <p id="reset-error-message"></p>

            <button id="reset-submit-btn" class="cta-button" disabled>
                <span class="btn-text">Neues Passwort speichern</span>
                <span class="btn-spinner"></span>
            </button>
        </div>

        <div id="message-view" class="action-section">
            <div class="styled-message-box" id="message-box-content">
                <i class="fa-solid fa-check-circle"></i>
                <h2 id="message-title">Erfolg</h2>
                <p id="message-text">Aktion war erfolgreich.</p>
                <button id="login-redirect-btn" class="cta-button" style="display: none;">
                    Zurück zum Login
                </button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            applyActionCode, 
            confirmPasswordReset,
            verifyPasswordResetCode 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCNXQuFW6SLR_w5x1NxlLScp17LjppAuCA",
            authDomain: "schulmensa-9de80.firebaseapp.com",
            projectId: "schulmensa-9de80",
            storageBucket: "schulmensa-9de80.firebasestorage.app",
            messagingSenderId: "930393675999",
            appId: "1:930393675999:web:cb4bb79f7a448b86efb16a",
            measurementId: "G-5TXS661SFP"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const loadingView = document.getElementById('loading-view');
        const resetView = document.getElementById('reset-view');
        const messageView = document.getElementById('message-view');

        const messageBox = document.getElementById('message-box-content');
        const messageTitle = document.getElementById('message-title');
        const messageText = document.getElementById('message-text');
        const loginRedirectBtn = document.getElementById('login-redirect-btn');
        
        const passwordInput = document.getElementById('reset-password');
        const togglePasswordBtn = document.getElementById('toggle-reset-password');
        const resetSubmitBtn = document.getElementById('reset-submit-btn');
        const resetErrorMsg = document.getElementById('reset-error-message');

        const lengthCheck = document.getElementById('length-check');
        const uppercaseCheck = document.getElementById('uppercase-check');
        const numberCheck = document.getElementById('number-check');

        function showSection(sectionToShow) {
            [loadingView, resetView, messageView].forEach(section => {
                section.classList.toggle('active', section === sectionToShow);
            });
        }

        function showMessage(title, text, isError = false) {
            messageTitle.textContent = title;
            messageText.textContent = text;
            messageBox.classList.toggle('error', isError);
            
            const icon = messageBox.querySelector('i');
            icon.className = isError ? 'fa-solid fa-circle-xmark' : 'fa-solid fa-check-circle';

            if (isError || title === "Passwort geändert!") {
                loginRedirectBtn.style.display = 'inline-block';
            } else {
                loginRedirectBtn.style.display = 'none';
            }

            showSection(messageView);
        }
        function validatePassword() {
            const pass = passwordInput.value;
            const hasLength = pass.length >= 8;
            const hasUppercase = /[A-Z]/.test(pass);
            const hasNumber = /[0-9]/.test(pass);

            lengthCheck.classList.toggle('valid', hasLength);
            uppercaseCheck.classList.toggle('valid', hasUppercase);
            numberCheck.classList.toggle('valid', hasNumber);

            const isValid = hasLength && hasUppercase && hasNumber;
            resetSubmitBtn.disabled = !isValid;
            return isValid;
        }
        
        passwordInput.addEventListener('input', validatePassword);
        
        togglePasswordBtn.addEventListener('click', (e) => {
             if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                e.target.classList.remove('fa-eye-slash');
                e.target.classList.add('fa-eye');
            } else {
                passwordInput.type = 'password';
                e.target.classList.remove('fa-eye');
                e.target.classList.add('fa-eye-slash');
            }
        });
        
        const setButtonLoading = (button, isLoading) => {
            if (!button) return;
            const btnText = button.querySelector('.btn-text');
            const btnSpinner = button.querySelector('.btn-spinner');
            button.disabled = isLoading;
            if (btnText) btnText.style.display = isLoading ? 'none' : 'inline-block';
            if (btnSpinner) btnSpinner.style.display = isLoading ? 'inline-block' : 'none';
        };

        loginRedirectBtn.addEventListener('click', () => {
            window.location.href = 'index.html'; 
        });

        window.onload = async function() {
            const params = new URLSearchParams(window.location.search);
            const mode = params.get('mode');
            const oobCode = params.get('oobCode');

            if (!mode || !oobCode) {
                showMessage('Fehler', 'Ungültiger oder fehlender Aktionslink.', true);
                return;
            }

            switch (mode) {
                case 'verifyEmail':
                    try {
                        await applyActionCode(auth, oobCode);
                        showMessage('Erfolgreich verifiziert!', 'Dein Konto ist jetzt aktiv. Du wirst in 2 Sekunden weitergeleitet.');
                        
                        setTimeout(() => {
                            window.location.href = "index.html"; 
                        }, 2000); 

                    } catch (error) {
                        console.error("Fehler bei verifyEmail:", error);
                        showMessage('Verifizierung fehlgeschlagen', 'Der Link ist möglicherweise ungültig oder bereits abgelaufen.', true);
                    }
                    break;

                case 'resetPassword':
                    try {
                        await verifyPasswordResetCode(auth, oobCode);
                        
                        showSection(resetView);
                        resetSubmitBtn.addEventListener('click', async () => {
                            if (!validatePassword()) {
                                resetErrorMsg.textContent = 'Bitte gib ein gültiges Passwort ein.';
                                resetErrorMsg.style.display = 'block';
                                return;
                            }
                            
                            setButtonLoading(resetSubmitBtn, true);
                            resetErrorMsg.style.display = 'none';
                            
                            try {
                                const newPassword = passwordInput.value;
                                await confirmPasswordReset(auth, oobCode, newPassword);
                                
                                showMessage('Passwort geändert!', 'Dein Passwort wurde erfolgreich zurückgesetzt. Du kannst dich jetzt damit anmelden.');
                            
                            } catch (error) {
                                console.error("Fehler bei confirmPasswordReset:", error);
                                resetErrorMsg.textContent = 'Fehler: ' + error.message;
                                resetErrorMsg.style.display = 'block';
                                setButtonLoading(resetSubmitBtn, false);
                            }
                        });

                    } catch (error) {
                        console.error("Fehler bei verifyPasswordResetCode:", error);
                        showMessage('Link ungültig', 'Dieser Link zum Zurücksetzen des Passworts ist ungültig oder abgelaufen.', true);
                    }
                    break;

                default:
                    showMessage('Unbekannte Aktion', 'Der Link scheint für eine nicht unterstützte Aktion zu sein.', true);
            }
        };
    </script>

</body>
</html>